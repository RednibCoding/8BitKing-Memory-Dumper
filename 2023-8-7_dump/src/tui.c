/* Copyright (C) 2024 Nikita Burnashev

Permission to use, copy, modify, and/or distribute this software
for any purpose with or without fee is hereby granted.

THIS SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND! */

/* MUST be self-contained for an incompatible version error reporting */

typedef unsigned char	uchar;
typedef unsigned short	ushort;
typedef unsigned int	uint;

static volatile uint *gma_reg = (void *)0xb8808100; // HCSEMI is abundant

void gma_reg_set(unsigned adr)
{
	gma_reg = (volatile void *)adr;
}

// github.com/bnister/PDK_GoBian/blob/master/pdk/linux/kernel/alidrivers/modules/alifb/
#define SCALE	4
#define WIDTH	(1280 / SCALE)
#define HEIGHT	(720 / SCALE)
#define BPP	16
#define GMA_PF	6 // RGB565 GMA_PIXEL_FORMAT ali_gma_m36f_lld.h#L88

#define VA2PA(VA) ((uint)(VA) & 0x0fffffff)

inline static void gma_hijack_osd_layer(void *p_screen)
{
	static struct gma_head_t { // ali_gma_m36f_hal.h#L60
		uchar	last_block:1, alpha_close:1, scale_on:1, ep_on:1, gma_mode:4;
		uchar	fossil1:1, clut_mode:1, clut_update:1, pre_mul:1, csc_mode:1;
		uchar	ep_reduce_thr, ep_avg_thr;
		uint	clut_base;
		ushort	start_x, end_x, start_y, end_y, source_width, source_height;
		ushort	fossil2:8, clut_segment:4, rgb_order:2, rsved11:2, pitch;
		uint	next_head, bitmap_addr;
		uint	scale_mode:1, rsved13:2, filter_select:1, rsved14:28;
		ushort	incr_h, incr_v;
	} gma_head = {
		.last_block	= 1,
		.scale_on	= SCALE > 1,
		.gma_mode	= GMA_PF,
		.end_x	= SCALE * WIDTH - 1,
		.end_y	= SCALE * HEIGHT - 1,
		.source_width	= WIDTH,
		.source_height	= HEIGHT,
		.pitch	= WIDTH * BPP / 8,
		.scale_mode	= 1,	// unfiltered (duplicate pixels)
		.incr_h	= 4096 / SCALE,	// ali_gma_m36f_lld.c#L2962
		.incr_v	= 4096 / SCALE
	};
	static _Alignas(32) struct { // C11
		uint head[8 * 2]; // 8Qword
		short h4v3_scale_coeff[2][16][8]; // ali_gma_m36f_lld.c#L2732
		int enhance_coef[4 * 3 + 1];
	} gma_block, *p_uncached;
	static const short csc_matrix_bt709[] = { // ali_gma_filtgen.c#L1129
		93, 314, 32, 0,    -52, -173, 225, 0,    225, -204, -21, 0
	};
	int i;

	gma_head.bitmap_addr = VA2PA(p_screen); // ali_gma_m36f_lld.c#L1025
	p_uncached = (void *)(0x20000000 + (uint)&gma_block); // #L693 #L668
	for (i = 0; i < 10; i++) p_uncached->head[i] = *((uint *)&gma_head + i);
	for (i = 0; i < 12; i++) p_uncached->enhance_coef[i] = csc_matrix_bt709[i];
	p_uncached->enhance_coef[12] = 0; // default sharpness filtgen.c#L1273
	gma_reg[0x250 / 4] |= 1;  // configuring VPOST _m36f_lld.c#L2623 #L274
	gma_reg[0x2d0 / 4] |= 1;  // needed for HiChip
	gma_reg[0x204 / 4] = VA2PA(&gma_block); // DMBA base addr #L2626 #L407
	gma_reg[0x250 / 4] &= ~1; // VPOST is ready gma_m36f_lld.c#L2627 #L295
	gma_reg[0x2d0 / 4] &= ~1;
}

static ushort screen[HEIGHT][WIDTH];

void tui_open(unsigned bg)
{
	uint x, y;

	for (y = 0; y < HEIGHT; y++)
		for (x = 0; x < WIDTH; x++) screen[y][x] = bg;
	gma_hijack_osd_layer(screen);
}

/* borrowed from RetroArch/gfx/drivers_font_renderer, usual license restrictions apply */
#define FONT_WIDTH 5
#define FONT_HEIGHT 10

#define FONT_WIDTH_STRIDE (FONT_WIDTH + 1)

#define FONT_OFFSET(x) ((x - 0x20) * ((FONT_HEIGHT * FONT_WIDTH + 7) / 8))

static const unsigned char rgui_font[] = {
   0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* code=0x20 */
   0x80,0x10,0x42,0x08,0x20,0x00,0x00, /* code=0x21 */
   0x4A,0x29,0x00,0x00,0x00,0x00,0x00, /* code=0x22 */
   0x00,0xA8,0xAF,0xD4,0x57,0x00,0x00, /* code=0x23 */
   0x80,0xF8,0xE2,0xE8,0x23,0x00,0x00, /* code=0x24 */
   0x60,0x4E,0x44,0x44,0xCE,0x00,0x00, /* code=0x25 */
   0xC0,0xA4,0x64,0x6A,0xB2,0x00,0x00, /* code=0x26 */
   0x84,0x10,0x00,0x00,0x00,0x00,0x00, /* code=0x27 */
   0x88,0x08,0x21,0x84,0x20,0x08,0x00, /* code=0x28 */
   0x82,0x20,0x84,0x10,0x22,0x02,0x00, /* code=0x29 */
   0x00,0x90,0xEA,0x2A,0x01,0x00,0x00, /* code=0x2a */
   0x00,0x10,0xF2,0x09,0x01,0x00,0x00, /* code=0x2b */
   0x00,0x00,0x00,0x00,0x20,0x02,0x00, /* code=0x2c */
   0x00,0x00,0xF0,0x01,0x00,0x00,0x00, /* code=0x2d */
   0x00,0x00,0x00,0x00,0x20,0x00,0x00, /* code=0x2e */
   0x10,0x22,0x44,0x88,0x10,0x01,0x00, /* code=0x2f */
   0xC0,0xC5,0x58,0x63,0x74,0x00,0x00, /* code=0x30 */
   0x80,0x18,0x42,0x08,0x71,0x00,0x00, /* code=0x31 */
   0xC0,0x45,0xC8,0x44,0xF8,0x00,0x00, /* code=0x32 */
   0xC0,0x45,0xC8,0x60,0x74,0x00,0x00, /* code=0x33 */
   0x00,0x31,0x95,0x3E,0x42,0x00,0x00, /* code=0x34 */
   0xE0,0x87,0xF0,0x60,0x74,0x00,0x00, /* code=0x35 */
   0x80,0x89,0xF0,0x62,0x74,0x00,0x00, /* code=0x36 */
   0xE0,0x43,0x84,0x08,0x11,0x00,0x00, /* code=0x37 */
   0xC0,0xC5,0xE8,0x62,0x74,0x00,0x00, /* code=0x38 */
   0xC0,0xC5,0xE8,0x21,0x32,0x00,0x00, /* code=0x39 */
   0x00,0x00,0x02,0x00,0x01,0x00,0x00, /* code=0x3a */
   0x00,0x00,0x02,0x00,0x11,0x00,0x00, /* code=0x3b */
   0x00,0x40,0x36,0x18,0x04,0x00,0x00, /* code=0x3c */
   0x00,0x80,0x0F,0x3E,0x00,0x00,0x00, /* code=0x3d */
   0x00,0x04,0x83,0x4D,0x00,0x00,0x00, /* code=0x3e */
   0xC0,0x45,0x88,0x08,0x20,0x00,0x00, /* code=0x3f */
   0xC0,0xC5,0x5A,0x7B,0xF0,0x00,0x00, /* code=0x40 */
   0x80,0x10,0xA5,0x5C,0x8C,0x00,0x00, /* code=0x41 */
   0xE0,0xC5,0xF8,0x62,0x7C,0x00,0x00, /* code=0x42 */
   0xC0,0xC5,0x10,0x42,0x74,0x00,0x00, /* code=0x43 */
   0xE0,0xA4,0x18,0x63,0x3A,0x00,0x00, /* code=0x44 */
   0xE0,0x87,0xF0,0x42,0xF8,0x00,0x00, /* code=0x45 */
   0xE0,0x87,0xF0,0x42,0x08,0x00,0x00, /* code=0x46 */
   0xC0,0xC5,0x90,0x63,0xF4,0x00,0x00, /* code=0x47 */
   0x20,0xC6,0xF8,0x63,0x8C,0x00,0x00, /* code=0x48 */
   0xC0,0x11,0x42,0x08,0x71,0x00,0x00, /* code=0x49 */
   0x80,0x43,0x08,0x21,0x7C,0x00,0x00, /* code=0x4a */
   0x20,0xA6,0x32,0x4A,0x8A,0x00,0x00, /* code=0x4b */
   0x20,0x84,0x10,0x42,0xF8,0x00,0x00, /* code=0x4c */
   0x20,0xC6,0xBD,0x6B,0x8D,0x00,0x00, /* code=0x4d */
   0x60,0xCE,0x5A,0x6B,0xCE,0x00,0x00, /* code=0x4e */
   0xC0,0xC5,0x18,0x63,0x74,0x00,0x00, /* code=0x4f */
   0xE0,0xC5,0xF8,0x42,0x08,0x00,0x00, /* code=0x50 */
   0xC0,0xC5,0x18,0x63,0xF6,0x00,0x00, /* code=0x51 */
   0xE0,0xC5,0xF8,0x62,0x8C,0x00,0x00, /* code=0x52 */
   0xC0,0xC5,0xE0,0x60,0x74,0x00,0x00, /* code=0x53 */
   0xE0,0x13,0x42,0x08,0x21,0x00,0x00, /* code=0x54 */
   0x20,0xC6,0x18,0x63,0x74,0x00,0x00, /* code=0x55 */
   0x20,0xC6,0xA8,0x14,0x21,0x00,0x00, /* code=0x56 */
   0x20,0xD6,0x5A,0x95,0x52,0x00,0x00, /* code=0x57 */
   0x20,0x46,0x45,0x54,0x8C,0x00,0x00, /* code=0x58 */
   0x20,0xC6,0xE8,0x08,0x21,0x00,0x00, /* code=0x59 */
   0xE0,0x43,0x44,0x44,0xF8,0x00,0x00, /* code=0x5a */
   0x4E,0x08,0x21,0x84,0x10,0x0E,0x00, /* code=0x5b */
   0x21,0x08,0x41,0x08,0x42,0x10,0x00, /* code=0x5c */
   0x0E,0x21,0x84,0x10,0x42,0x0E,0x00, /* code=0x5d */
   0x80,0xA8,0x08,0x00,0x00,0x00,0x00, /* code=0x5e */
   0x00,0x00,0x00,0x00,0x00,0x1F,0x00, /* code=0x5f */
   0x80,0x20,0x00,0x00,0x00,0x00,0x00, /* code=0x60 */
   0x00,0x00,0x07,0x7D,0xF4,0x00,0x00, /* code=0x61 */
   0x21,0x84,0x17,0x63,0x7C,0x00,0x00, /* code=0x62 */
   0x00,0x00,0x1F,0x42,0xF0,0x00,0x00, /* code=0x63 */
   0x10,0x42,0x1F,0x63,0xF4,0x00,0x00, /* code=0x64 */
   0x00,0x00,0x17,0x7F,0xF0,0x00,0x00, /* code=0x65 */
   0x5C,0x88,0x27,0x84,0x10,0x00,0x00, /* code=0x66 */
   0x00,0x00,0x17,0x63,0xF4,0xD0,0x01, /* code=0x67 */
   0x21,0x84,0x17,0x63,0x8C,0x00,0x00, /* code=0x68 */
   0x80,0x00,0x43,0x08,0x21,0x00,0x00, /* code=0x69 */
   0x00,0x01,0x86,0x10,0x42,0xE8,0x00, /* code=0x6a */
   0x42,0x08,0xA9,0x8C,0x92,0x00,0x00, /* code=0x6b */
   0x86,0x10,0x42,0x08,0x21,0x00,0x00, /* code=0x6c */
   0x00,0x80,0x55,0x6B,0xAD,0x00,0x00, /* code=0x6d */
   0x00,0x80,0x17,0x63,0x8C,0x00,0x00, /* code=0x6e */
   0x00,0x00,0x17,0x63,0x74,0x00,0x00, /* code=0x6f */
   0x00,0x80,0x17,0x63,0x7C,0x21,0x00, /* code=0x70 */
   0x00,0x00,0x1F,0x63,0xF4,0x10,0x02, /* code=0x71 */
   0x00,0x80,0x36,0x43,0x08,0x00,0x00, /* code=0x72 */
   0x00,0x00,0x1F,0x1C,0x7C,0x00,0x00, /* code=0x73 */
   0x40,0x08,0x27,0x84,0xE0,0x00,0x00, /* code=0x74 */
   0x00,0x80,0x18,0x63,0xF4,0x00,0x00, /* code=0x75 */
   0x00,0x80,0x18,0x95,0x22,0x00,0x00, /* code=0x76 */
   0x00,0x80,0x58,0xAB,0x52,0x00,0x00, /* code=0x77 */
   0x00,0x80,0xA8,0x88,0x8A,0x00,0x00, /* code=0x78 */
   0x00,0x80,0x18,0x63,0xF4,0xD0,0x01, /* code=0x79 */
   0x00,0x80,0x8F,0x88,0xF8,0x00,0x00, /* code=0x7a */
   0x88,0x10,0x22,0x08,0x21,0x08,0x00, /* code=0x7b */
   0x84,0x10,0x42,0x08,0x21,0x04,0x00, /* code=0x7c */
   0x82,0x10,0x82,0x08,0x21,0x02,0x00, /* code=0x7d */
   0x00,0x00,0x60,0x1B,0x00,0x00,0x00, /* code=0x7e */
   0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* code=0x7f */
};

void tui_add(int grid_x, int grid_y, unsigned fg, unsigned bg, const char *msg)
{
	const uint msg_x = grid_x * FONT_WIDTH_STRIDE, msg_y = grid_y * FONT_HEIGHT;
	uint x, y;

	for (y = 0; y < FONT_HEIGHT; y++) {
		for (x = 0; x < WIDTH - msg_x; x++) {
			uint symbol_index = msg[x / FONT_WIDTH_STRIDE];
			uint i = (x % FONT_WIDTH_STRIDE), j = y % FONT_HEIGHT;
			uchar rem = 1 << ((i + j * FONT_WIDTH) & 7);
			uint offset = (i + j * FONT_WIDTH) >> 3;

			if (!symbol_index) break;
			if (i < FONT_WIDTH && (rgui_font[FONT_OFFSET(symbol_index) + offset] & rem) > 0)
				screen[y + msg_y][x + msg_x] = fg;
			else
				screen[y + msg_y][x + msg_x] = bg;
		}
	}
}
